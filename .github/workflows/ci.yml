name: CI/CD Pipeline

on:
  pull_request:
  push:
    branches: [main]

# Security: Minimal permissions (C3)
permissions:
  contents: read
  security-events: write

# Concurrency: Cancel duplicate runs (C2)
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# Environment variables
env:
  PYTHON_VERSION: "3.11"
  DOCKER_IMAGE: reading-list-api

jobs:
  # ===========================================================================
  # Job 1: Code Quality & Tests (C1)
  # ===========================================================================
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        timeout-minutes: 3
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt

      - name: Lint & Format
        timeout-minutes: 2
        run: |
          ruff check --output-format=github .
          black --check .
          isort --check-only .

      - name: Security SAST Scan (Bandit)
        timeout-minutes: 2
        run: bandit -r app/ -ll -ii -x tests/

      - name: Run Tests with Coverage
        timeout-minutes: 5
        run: |
          mkdir -p reports
          pytest -q \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml:reports/coverage.xml \
            --cov-report=html:reports/htmlcov \
            --junitxml=reports/junit.xml \
            --cov-fail-under=80

      - name: Dependency Security Scan (pip-audit)
        timeout-minutes: 2
        run: pip-audit --progress-spinner=off || echo "::warning::Dependency vulnerabilities found"
        continue-on-error: true

      - name: Pre-commit checks
        timeout-minutes: 3
        run: pre-commit run --all-files

      # Artifacts: Save test reports (C4)
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: reports/
          retention-days: 7

      # Summary
      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reports/coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree=ET.parse('reports/coverage.xml'); print(f\"{float(tree.getroot().attrib['line-rate'])*100:.1f}%\")")
            echo "**Coverage:** $COVERAGE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 2: Container Security (P07)
  # ===========================================================================
  container-security:
    name: Container Security
    runs-on: ubuntu-latest
    needs: build-and-test
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Dockerfile (Hadolint)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          failure-threshold: warning

      - name: Build Docker image
        timeout-minutes: 5
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ github.sha }} .
          docker tag ${{ env.DOCKER_IMAGE }}:${{ github.sha }} ${{ env.DOCKER_IMAGE }}:latest

      - name: Scan image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.DOCKER_IMAGE }}:latest'
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Verify non-root user
        run: |
          USER_ID=$(docker run --rm --entrypoint id ${{ env.DOCKER_IMAGE }}:latest -u)
          echo "Container user ID: $USER_ID"
          if [ "$USER_ID" = "0" ]; then
            echo "::error::Container is running as root!"
            exit 1
          fi
          echo "âœ… Container runs as non-root user (UID: $USER_ID)"

      - name: Verify healthcheck
        timeout-minutes: 3
        run: |
          docker run -d --name test-app -p 8000:8000 ${{ env.DOCKER_IMAGE }}:latest
          echo "Waiting for container to be healthy..."
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' test-app 2>/dev/null || echo "starting")
            if [ "$STATUS" = "healthy" ]; then
              echo "âœ… Container is healthy!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "::error::Container did not become healthy"
              docker logs test-app
              exit 1
            fi
            sleep 2
          done
          curl -f http://localhost:8000/health
          docker stop test-app && docker rm test-app

      - name: Docker image info
        run: |
          echo "### ðŸ³ Docker Image Info" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          docker images ${{ env.DOCKER_IMAGE }} --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 3: CD - Staging Deploy (C5)
  # ===========================================================================
  deploy-staging:
    name: Deploy to Staging (Dry-Run)
    runs-on: ubuntu-latest
    needs: [build-and-test, container-security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 5

    environment:
      name: staging
      url: https://staging.example.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image for staging
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:staging-${{ github.sha }} .

      - name: Deploy to staging (dry-run)
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo ""
          echo "Image: ${{ env.DOCKER_IMAGE }}:staging-${{ github.sha }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "ðŸ“‹ Deployment steps (dry-run):"
          echo "  1. Pull image from registry"
          echo "  2. Stop existing container"
          echo "  3. Start new container"
          echo "  4. Run health checks"
          echo "  5. Update load balancer"
          echo ""
          echo "âœ… Staging deployment simulation complete!"

      - name: Smoke test staging
        run: |
          echo "ðŸ” Running smoke tests..."
          # In real deployment, this would test the staging URL
          echo "  - Health check: PASSED"
          echo "  - API endpoint: PASSED"
          echo "  - Database connection: PASSED"
          echo ""
          echo "âœ… All smoke tests passed!"

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | staging |" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.DOCKER_IMAGE }}:staging-${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success (dry-run) |" >> $GITHUB_STEP_SUMMARY
