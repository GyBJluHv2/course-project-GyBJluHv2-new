name: Security - SAST & Secrets

on:
  workflow_dispatch:
  push:
    paths:
      - "requirements*.txt"
      - "**/*.py"
      - ".github/workflows/ci-sast-secrets.yml"
      - "security/semgrep/**"
      - "security/.gitleaks.toml"

permissions:
  contents: read

concurrency:
  group: sast-secrets-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sast-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare directories
        run: mkdir -p EVIDENCE/P10

      - name: Run Semgrep (p/ci + custom rules)
        run: |
          docker run --rm \
            -v "$PWD:/src" -w /src \
            returntocorp/semgrep:latest semgrep ci \
            --config p/ci \
            --config /src/security/semgrep/rules.yml \
            --sarif --output /src/EVIDENCE/P10/semgrep.sarif \
            --metrics=off || true

      - name: Run Gitleaks (secrets scan)
        run: |
          docker run --rm \
            -v "$PWD:/repo" \
            zricethezav/gitleaks:latest detect \
              --no-banner \
              --config=/repo/security/.gitleaks.toml \
              --source=/repo \
              --report-format=json \
              --report-path=/repo/EVIDENCE/P10/gitleaks.json || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sast-secrets-artifacts
          path: |
            EVIDENCE/P10/semgrep.sarif
            EVIDENCE/P10/gitleaks.json
          retention-days: 7

      - name: Generate SAST/Secrets summary
        run: |
          python - <<'PY'
          import json
          from collections import Counter
          from pathlib import Path

          evidence_dir = Path("EVIDENCE/P10")
          evidence_dir.mkdir(parents=True, exist_ok=True)
          summary = []

          # Semgrep SARIF
          semgrep_path = evidence_dir / "semgrep.sarif"
          sev_map = {
              "error": "HIGH",
              "warning": "MEDIUM",
              "note": "LOW",
          }
          if semgrep_path.exists():
              try:
                  data = json.loads(semgrep_path.read_text(encoding="utf-8"))
                  levels = Counter()
                  for run in data.get("runs", []):
                      for res in run.get("results", []):
                          level = res.get("level", "unknown").lower()
                          levels[sev_map.get(level, "UNKNOWN")] += 1
                  summary.append("# Semgrep Findings")
                  if levels:
                      for sev in ["CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"]:
                          if levels[sev]:
                              summary.append(f"- {sev}: {levels[sev]}")
                  else:
                      summary.append("- No findings")
              except Exception as e:
                  summary.append(f"# Semgrep Findings\n- Failed to parse SARIF: {e}")
          else:
              summary.append("# Semgrep Findings\n- Report not found")

          # Gitleaks JSON
          gitleaks_path = evidence_dir / "gitleaks.json"
          if gitleaks_path.exists():
              try:
                  data = json.loads(gitleaks_path.read_text(encoding="utf-8"))
                  # Gitleaks may return list or dict with findings/results
                  leaks = []
                  if isinstance(data, list):
                      leaks = data
                  elif isinstance(data, dict):
                      leaks = (
                          data.get("findings")
                          or data.get("results")
                          or data.get("Leaks")
                          or []
                      )
                  count = len(leaks) if isinstance(leaks, list) else 0
                  summary.append("\n# Gitleaks Findings")
                  summary.append(f"- Total findings: {count}")
                  if count == 0:
                      summary.append("- No secrets detected")
                  else:
                      sample = leaks[0] if leaks else {}
                      rule = (
                          sample.get("RuleID")
                          or sample.get("ruleID")
                          or sample.get("rule")
                          or "n/a"
                      )
                      summary.append(f"- Example rule: {rule}")
              except Exception as e:
                  summary.append(f"\n# Gitleaks Findings\n- Failed to parse report: {e}")
          else:
              summary.append("\n# Gitleaks Findings\n- Report not found")

          out = evidence_dir / "sast_summary.md"
          out.write_text("\n".join(summary), encoding="utf-8")
          PY

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: sast-secrets-summary
          path: EVIDENCE/P10/sast_summary.md
          retention-days: 7

      - name: Job summary
        if: always()
        run: |
          echo "## SAST & Secrets" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- EVIDENCE/P10/semgrep.sarif" >> $GITHUB_STEP_SUMMARY
          echo "- EVIDENCE/P10/gitleaks.json" >> $GITHUB_STEP_SUMMARY
          echo "- EVIDENCE/P10/sast_summary.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Triggered by: $GITHUB_EVENT_NAME" >> $GITHUB_STEP_SUMMARY
